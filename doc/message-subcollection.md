# Message Subcollection System

## Overview

The message subcollection system enables communication between proponents, REC chairpersons, and reviewers for each submission. Messages are stored as subcollections within each submission document across all four submission collections.

## Database Structure

### Collection Hierarchy
```
submissions_pending/{submissionId}/messages/{messageId}
submissions_accepted/{submissionId}/messages/{messageId}
submissions_approved/{submissionId}/messages/{messageId}
submissions_archived/{submissionId}/messages/{messageId}
```

### Message Document Structure
```typescript
interface MessagesType {
  id: string;           // Firestore document ID
  senderId: string;     // User ID of sender (proponent/reviewer/admin)
  senderName: string;   // Display name of sender
  content: string;      // Message content/text
  createdAt: string;    // ISO timestamp when sent
  type?: MessageType;   // "system" | "private" | "reply"
  status?: MessageStatus; // "sent" | "delivered" | "read"
}
```

## Available Functions

### Core Message Operations

#### `sendMessage(submissionId, collectionName, senderId, senderName, content, type?)`
- Sends a message to a specific submission in a specific collection
- Returns the message ID
- Automatically sets timestamp and status

#### `getSubmissionMessages(submissionId, collectionName)`
- Retrieves all messages for a submission in chronological order
- Returns array of MessagesType objects

#### `markMessageAsRead(submissionId, collectionName, messageId)`
- Marks a specific message as "read"
- Used for tracking message status

#### `getUnreadMessageCount(submissionId, collectionName, userId)`
- Gets count of unread messages (excludes messages sent by the user)
- Returns number

### Convenience Functions

#### `getMessagesForSubmission(submissionId)`
- Automatically detects which collection the submission is in
- Fetches all messages without needing to specify collection
- Recommended for general use

#### `sendMessageToSubmission(submissionId, senderId, senderName, content, type?)`
- Automatically detects which collection the submission is in
- Sends message without needing to specify collection
- Recommended for general use

## Usage Examples

### Sending a Message
```typescript
// Proponent sending a message
await sendMessageToSubmission(
  "REC_2025_ABC123",
  user.uid,
  "Dr. John Smith",
  "Thank you for the feedback. I have updated the consent form.",
  "reply"
);

// System message (status change)
await sendMessageToSubmission(
  "REC_2025_ABC123",
  "system",
  "System",
  "Protocol status changed to Approved",
  "system"
);
```

### Fetching Messages
```typescript
// Get all messages for a submission
const messages = await getMessagesForSubmission("REC_2025_ABC123");

// Display messages in chronological order
messages.forEach(message => {
  console.log(`${message.senderName}: ${message.content}`);
});
```

### Checking Unread Messages
```typescript
// Get unread count (for notifications)
const unreadCount = await getUnreadMessageCount(
  "REC_2025_ABC123",
  "submissions_pending",
  user.uid
);
```

## Message Types

### `"system"`
- Automatic messages generated by the system
- Status changes, reminders, etc.
- Sender ID: "system"

### `"private"`
- Messages visible only to reviewers/admin
- Internal notes and discussions
- Not visible to proponents

### `"reply"`
- Regular communication messages
- Visible to all relevant parties
- Default message type

## Security Considerations

### Access Control
- **Proponents**: Can only see messages in their own submissions
- **Reviewers**: Can see messages in submissions they're assigned to review
- **REC Chair**: Can see all messages
- **Admin**: Full access to all messages

### Message Visibility
- System messages: Visible to all parties
- Reply messages: Visible to proponents and reviewers
- Private messages: Only visible to reviewers and admin

## Integration Points

### Protocol Detail View
- Display message thread in protocol detail page
- Real-time message updates
- Send message functionality

### Dashboard
- Show unread message count badges
- Quick message preview

### Notifications
- Email notifications for new messages
- In-app notification system

## Future Enhancements

1. **File Attachments**: Support for attaching documents to messages
2. **Message Threading**: Reply to specific messages
3. **Typing Indicators**: Real-time typing status
4. **Message Search**: Search through message history
5. **Message Reactions**: Like/acknowledge messages
6. **Auto-notifications**: Automatic email/SMS for important messages

## Database Indexes Required

For optimal performance, create the following Firestore indexes:

```
Collection: submissions_pending/{submissionId}/messages
- senderId (ASC), createdAt (ASC)
- status (ASC), createdAt (ASC)
- type (ASC), createdAt (ASC)

Collection: submissions_accepted/{submissionId}/messages
- senderId (ASC), createdAt (ASC)
- status (ASC), createdAt (ASC)
- type (ASC), createdAt (ASC)

Collection: submissions_approved/{submissionId}/messages
- senderId (ASC), createdAt (ASC)
- status (ASC), createdAt (ASC)
- type (ASC), createdAt (ASC)

Collection: submissions_archived/{submissionId}/messages
- senderId (ASC), createdAt (ASC)
- status (ASC), createdAt (ASC)
- type (ASC), createdAt (ASC)
```

These indexes support queries for:
- Getting messages by sender
- Finding unread messages
- Filtering by message type
- Chronological ordering