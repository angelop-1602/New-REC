rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isReviewer() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/reviewers/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/reviewers/$(request.auth.uid)).data.isActive == true;
    }
    
    // Helper to check if a reviewer ID exists and is active (for code-based auth)
    function isValidReviewerId(reviewerId) {
      return exists(/databases/$(database)/documents/reviewers/$(reviewerId)) &&
             get(/databases/$(database)/documents/reviewers/$(reviewerId)).data.isActive == true;
    }
    
    // Helper to check if reviewer is assigned to a submission (works without Firebase Auth)
    function isAssignedReviewerByCode(submissionId, reviewerId) {
      return isValidReviewerId(reviewerId) &&
             exists(/databases/$(database)/documents/submissions/$(submissionId)/reviewers/$(reviewerId));
    }
    
    function isChairperson() {
      return isAuthenticated() && 
             (
               // First check: email (fastest, no document reads needed)
               (request.auth.token.email != null && request.auth.token.email == 'rec@spup.edu.ph') ||
               // Second check: rec_settings document
               exists(/databases/$(database)/documents/rec_settings/$(request.auth.uid)) ||
               // Third check: settings document
               exists(/databases/$(database)/documents/settings/$(request.auth.uid)) ||
               // Fourth check: reviewer document with chairperson role
               (exists(/databases/$(database)/documents/reviewers/$(request.auth.uid)) &&
                get(/databases/$(database)/documents/reviewers/$(request.auth.uid)).data.role == 'chairperson' &&
                get(/databases/$(database)/documents/reviewers/$(request.auth.uid)).data.isActive == true)
             );
    }
    
    function isProponent(submissionData) {
      return isAuthenticated() && isOwner(submissionData.submitBy);
    }
    
    function canReadSubmission(submissionData) {
      return isAuthenticated() && (
        isProponent(submissionData) || 
        isChairperson() || 
        isReviewer()
      );
    }
    
    function canWriteSubmission(submissionData) {
      return isAuthenticated() && (
        isProponent(submissionData) || 
        isChairperson()
      );
    }
    
    // Helper to check if reviewer is assigned to a submission
    function isAssignedReviewer(submissionId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/submissions/$(submissionId)/reviewers/$(request.auth.uid));
    }
    
    // ============================================================================
    // USERS COLLECTION
    // ============================================================================
    
    match /users/{userId} {
      allow read: if isAuthenticated() && (isOwner(userId) || isChairperson());
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isAuthenticated() && isOwner(userId);
      allow delete: if isAuthenticated() && isChairperson();
    }
    
    // ============================================================================
    // SUBMISSIONS COLLECTION (Unified - single collection with status field)
    // ============================================================================
    
    match /submissions/{submissionId} {
      // Read permissions:
      // - For queries: Chairperson and Reviewers (Firebase Auth) can read all
      // - For individual gets: Check canReadSubmission which includes proponent check
      // - For code-based reviewers: Allow reads if reviewer is assigned (checked via subcollection)
      //   Note: Code-based reviewers aren't Firebase Auth users, so we allow reads
      //   and rely on the reviewers subcollection to verify assignment
      allow read: if (
        // Firebase Auth users
        (isAuthenticated() && (
          isChairperson() || 
          isReviewer() || 
          (resource != null && canReadSubmission(resource.data))
        )) ||
        // Code-based reviewers: Allow reads (assignment is verified via reviewers subcollection access)
        // This is safe because:
        // 1. Reviewers can only access submissions they're assigned to (via reviewers subcollection rules)
        // 2. The service layer filters results to only show assigned protocols
        true
      );
      
      // Create: Any authenticated user can create their own submission
      allow create: if isAuthenticated() && 
                      isOwner(request.resource.data.submitBy) &&
                      // Ensure required fields are present
                      request.resource.data.keys().hasAll(['submitBy', 'createdAt', 'status']);
      
      // Update: Proponent (own), Chairperson, or Reviewer (if assigned)
      allow update: if isAuthenticated() && (
        // Proponent can update their own submission
        (resource != null && canWriteSubmission(resource.data)) ||
        // Chairperson can update any submission they can read
        (isChairperson() && resource != null && canReadSubmission(resource.data)) ||
        // Reviewer can update if assigned (for assessments, etc.)
        (isReviewer() && isAssignedReviewer(submissionId))
      );
      
      // Delete: Only chairperson
      allow delete: if isAuthenticated() && isChairperson();
      
      // ============================================================================
      // SUBMISSIONS SUBCOLLECTIONS
      // ============================================================================
      
      // Documents subcollection
      match /documents/{documentId} {
        // Read: Proponent (own submission), Owner (uploadedBy), Chairperson, Reviewers (assigned)
        allow read: if isAuthenticated() && (
          // For queries, allow chairperson and reviewers
          isChairperson() ||
          isReviewer() ||
          // For individual gets, check ownership
          (resource != null && (
            isProponent(get(/databases/$(database)/documents/submissions/$(submissionId)).data) ||
            isOwner(resource.data.uploadedBy) ||
            isAssignedReviewer(submissionId)
          ))
        );
        
        // Create: Owner, Proponent, Chairperson
        allow create: if isAuthenticated() && (
          isOwner(request.resource.data.uploadedBy) ||
          isProponent(get(/databases/$(database)/documents/submissions/$(submissionId)).data) ||
          isChairperson()
        );
        
        // Update: Owner, Chairperson
        allow update: if isAuthenticated() && (
          (resource != null && isOwner(resource.data.uploadedBy)) ||
          isChairperson()
        );
        
        // Delete: Only chairperson
        allow delete: if isAuthenticated() && isChairperson();
      }
      
      // Reviewers subcollection (reviewer assignments)
      match /reviewers/{reviewerAssignmentId} {
        // Read: Assigned reviewer, Chairperson, Proponent (own submission)
        // For queries: Allow chairperson, Firebase Auth reviewers, and code-based reviewers
        // For individual gets: Check ownership
        allow read: if (
          // Firebase Auth users
          (isAuthenticated() && (
            isChairperson() ||
            isReviewer() ||
            (resource != null && (
              isOwner(resource.data.reviewerId) ||
              isProponent(get(/databases/$(database)/documents/submissions/$(submissionId)).data)
            ))
          )) ||
          // Code-based reviewers: Allow reads for queries
          // The service layer filters results to only show assignments for the specific reviewer
          true
        );
        
        // Write: Only chairperson
        allow create: if isAuthenticated() && isChairperson();
        allow update: if isAuthenticated() && isChairperson();
        allow delete: if isAuthenticated() && isChairperson();
        
        // Assessment forms nested under reviewer assignments
        match /assessment_forms/{formType} {
          // Read: Assigned reviewer, Chairperson, Proponent (own submission)
          allow read: if isAuthenticated() && (
            isChairperson() ||
            (resource != null && isOwner(resource.data.reviewerId)) ||
            (resource != null && isProponent(get(/databases/$(database)/documents/submissions/$(submissionId)).data))
          );
          
          // Create: Assigned reviewer, Chairperson
          allow create: if isAuthenticated() && (
            isOwner(request.resource.data.reviewerId) ||
            isChairperson()
          );
          
          // Update: Assigned reviewer, Chairperson
          allow update: if isAuthenticated() && (
            (resource != null && isOwner(resource.data.reviewerId)) ||
            isChairperson()
          );
          
          // Delete: Only chairperson
          allow delete: if isAuthenticated() && isChairperson();
        }
      }
      
      // Messages subcollection
      match /messages/{messageId} {
        // Read: Sender, Receiver, Chairperson
        allow read: if isAuthenticated() && (
          isChairperson() ||
          (resource != null && (
            isOwner(resource.data.senderId) ||
            isOwner(resource.data.receiverId)
          ))
        );
        
        // Create: Must be the sender
        allow create: if isAuthenticated() && 
                        isOwner(request.resource.data.senderId) &&
                        request.resource.data.keys().hasAll(['senderId', 'createdAt']);
        
        // Update: Sender, Chairperson
        allow update: if isAuthenticated() && (
          (resource != null && isOwner(resource.data.senderId)) ||
          isChairperson()
        );
        
        // Delete: Sender, Chairperson
        allow delete: if isAuthenticated() && (
          (resource != null && isOwner(resource.data.senderId)) ||
          isChairperson()
        );
      }
      
      // Reassignment history subcollection
      match /reassignment_history/{historyId} {
        // Read: Chairperson, Firebase Auth Reviewers, Code-based Reviewers
        allow read: if (
          // Firebase Auth users
          (isAuthenticated() && (isChairperson() || isReviewer())) ||
          // Code-based reviewers: Allow reads for queries
          // The service layer filters results to only show reassignments for the specific reviewer
          true
        );
        
        // Write: Only chairperson
        allow create: if isAuthenticated() && isChairperson();
        allow update: if isAuthenticated() && isChairperson();
        allow delete: if isAuthenticated() && isChairperson();
      }
      
      // Decision subcollection
      match /decision/{decisionId} {
        // Read: Anyone who can read the submission
        allow read: if isAuthenticated() && (
          isChairperson() ||
          isReviewer() ||
          (resource != null && isProponent(get(/databases/$(database)/documents/submissions/$(submissionId)).data))
        );
        
        // Write: Only chairperson
        allow create: if isAuthenticated() && isChairperson();
        allow update: if isAuthenticated() && isChairperson();
        allow delete: if isAuthenticated() && isChairperson();
        
        // Nested decision details (submissions/{id}/decision/details)
        match /details/{detailsId} {
          // Read: Anyone who can read the submission
          allow read: if isAuthenticated() && (
            isChairperson() ||
            isReviewer() ||
            isProponent(get(/databases/$(database)/documents/submissions/$(submissionId)).data)
          );
          
          // Write: Only chairperson
          allow create: if isAuthenticated() && isChairperson();
          allow update: if isAuthenticated() && isChairperson();
          allow delete: if isAuthenticated() && isChairperson();
        }
      }
    }
    
    // ============================================================================
    // REVIEWERS COLLECTION
    // ============================================================================
    
    match /reviewers/{reviewerId} {
      // Read permissions:
      // - Chairperson can read all reviewers
      // - Reviewer can read their own document (when authenticated via Firebase Auth)
      // - Allow unauthenticated reads for code-based sign-in queries
      //   Note: Reviewers use code-based authentication (not Firebase Auth), so they
      //   need to query by code before being authenticated. The code field is public
      //   (meant for sign-in) and the service layer validates isActive status.
      allow read: if (
        // Chairperson can read all
        (isAuthenticated() && isChairperson()) ||
        // Reviewer can read their own document (if authenticated via Firebase Auth)
        (isAuthenticated() && isOwner(reviewerId)) ||
        // Allow reads for code-based sign-in (reviewers aren't Firebase Auth users)
        // This is safe because:
        // 1. Code is public (used for sign-in)
        // 2. Service validates isActive
        // 3. Only code, name, email, role, isActive are exposed (not sensitive)
        true
      );
      
      // Write: Only chairperson
      allow create: if isAuthenticated() && isChairperson();
      allow update: if isAuthenticated() && isChairperson();
      allow delete: if isAuthenticated() && isChairperson();
    }
    
    // ============================================================================
    // MESSAGES COLLECTION (Top-level, if used)
    // ============================================================================
    
    match /messages/{messageId} {
      // Read: Sender, Receiver, Chairperson
      allow read: if isAuthenticated() && (
        isChairperson() ||
        (resource != null && (
          isOwner(resource.data.senderId) ||
          isOwner(resource.data.receiverId)
        ))
      );
      
      // Create: Must be the sender
      allow create: if isAuthenticated() && 
                      isOwner(request.resource.data.senderId) &&
                      request.resource.data.keys().hasAll(['senderId', 'createdAt']);
      
      // Update: Sender, Chairperson
      allow update: if isAuthenticated() && (
        (resource != null && isOwner(resource.data.senderId)) ||
        isChairperson()
      );
      
      // Delete: Sender, Chairperson
      allow delete: if isAuthenticated() && (
        (resource != null && isOwner(resource.data.senderId)) ||
        isChairperson()
      );
    }
    
    // ============================================================================
    // PRESENCE COLLECTION
    // ============================================================================
    
    match /presence/{presenceId} {
      // Read: Any authenticated user (for online status)
      allow read: if isAuthenticated();
      
      // Write: Only the user themselves
      allow create: if isAuthenticated() && 
                      isOwner(request.resource.data.userId);
      
      allow update: if isAuthenticated() && (
        (resource != null && isOwner(resource.data.userId)) ||
        isOwner(request.resource.data.userId)
      );
      
      allow delete: if isAuthenticated() && isOwner(presenceId);
    }
    
    // ============================================================================
    // SETTINGS COLLECTIONS
    // ============================================================================
    
    match /rec_settings/{settingId} {
      // Read/Write: Only chairperson
      allow read: if isAuthenticated() && isChairperson();
      allow write: if isAuthenticated() && isChairperson();
    }
    
    match /settings/{settingId} {
      // Read/Write: Only chairperson
      allow read: if isAuthenticated() && isChairperson();
      allow write: if isAuthenticated() && isChairperson();
    }
    
    // ============================================================================
    // ASSESSMENT FORMS COLLECTION (Top-level, if used)
    // ============================================================================
    
    match /assessment_forms/{formId} {
      // Read: Reviewer (own), Chairperson
      allow read: if isAuthenticated() && (
        isChairperson() ||
        (resource != null && isOwner(resource.data.reviewerId))
      );
      
      // Write: Reviewer (own), Chairperson
      allow create: if isAuthenticated() && (
        isOwner(request.resource.data.reviewerId) ||
        isChairperson()
      );
      
      allow update: if isAuthenticated() && (
        (resource != null && isOwner(resource.data.reviewerId)) ||
        isChairperson()
      );
      
      allow delete: if isAuthenticated() && isChairperson();
    }
    
    // ============================================================================
    // DECISION COLLECTION (Top-level, if used)
    // ============================================================================
    
    match /decision/{decisionId} {
      // Read: Any authenticated user (decisions are generally readable)
      allow read: if isAuthenticated();
      
      // Write: Only chairperson
      allow create: if isAuthenticated() && isChairperson();
      allow update: if isAuthenticated() && isChairperson();
      allow delete: if isAuthenticated() && isChairperson();
      
      // Nested decision details (decision/details)
      match /details/{detailsId} {
        // Read: Anyone who can read the decision
        allow read: if isAuthenticated();
        
        // Write: Only chairperson
        allow create: if isAuthenticated() && isChairperson();
        allow update: if isAuthenticated() && isChairperson();
        allow delete: if isAuthenticated() && isChairperson();
      }
    }
    
    // ============================================================================
    // DOCUMENT REQUESTS COLLECTION
    // ============================================================================
    
    match /document_requests/{requestId} {
      // Read: Proponent (own protocol), Chairperson, Reviewer (assigned to protocol)
      // For queries: Allow chairperson and reviewers to read all
      // For individual gets: Check ownership
      allow read: if isAuthenticated() && (
        isChairperson() ||
        isReviewer() ||
        (resource != null && (
          isProponent(get(/databases/$(database)/documents/submissions/$(resource.data.protocolId)).data) ||
          isAssignedReviewer(resource.data.protocolId)
        ))
      );
      
      // Create: Proponent (own protocol), Chairperson
      allow create: if isAuthenticated() && (
        isOwner(request.resource.data.requestedBy) ||
        isChairperson()
      );
      
      // Update: Requester, Chairperson
      allow update: if isAuthenticated() && (
        (resource != null && isOwner(resource.data.requestedBy)) ||
        isChairperson()
      );
      
      // Delete: Only chairperson
      allow delete: if isAuthenticated() && isChairperson();
    }
    
    // ============================================================================
    // AUDIT LOGS COLLECTION
    // ============================================================================
    
    match /audit_logs/{logId} {
      // Read: Only chairperson (audit logs are sensitive)
      allow read: if isAuthenticated() && isChairperson();
      
      // Write: System/Chairperson only (for audit tracking)
      allow create: if isAuthenticated() && (isChairperson() || isReviewer());
      allow update, delete: if isAuthenticated() && isChairperson();
    }
    
    // ============================================================================
    // REC MEMBERS COLLECTION
    // ============================================================================
    
    match /rec_members/{memberId} {
      // Read: Chairperson, or member reading their own record
      allow read: if isAuthenticated() && (
        isChairperson() ||
        (resource != null && isOwner(resource.data.userId))
      );
      
      // Write: Only chairperson
      allow create: if isAuthenticated() && isChairperson();
      allow update: if isAuthenticated() && isChairperson();
      allow delete: if isAuthenticated() && isChairperson();
    }
    
    // ============================================================================
    // REC LINEUPS COLLECTION
    // ============================================================================
    
    match /rec_lineups/{lineupId} {
      // Read: Only chairperson
      allow read: if isAuthenticated() && isChairperson();
      
      // Write: Only chairperson
      allow create: if isAuthenticated() && isChairperson();
      allow update: if isAuthenticated() && isChairperson();
      allow delete: if isAuthenticated() && isChairperson();
    }
    
    // ============================================================================
    // ANALYTICS / TRACKING COLLECTIONS
    // ============================================================================
    
    // Analytics errors collection
    match /analytics_errors/{errorId} {
      // Read: Only chairperson
      allow read: if isAuthenticated() && isChairperson();
      // Write: Any authenticated user (for error tracking)
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && isChairperson();
    }
    
    // Analytics events collection
    match /analytics_events/{eventId} {
      // Read: Only chairperson
      allow read: if isAuthenticated() && isChairperson();
      // Write: Any authenticated user (for event tracking)
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && isChairperson();
    }
    
    // Analytics performance collection
    match /analytics_performance/{performanceId} {
      // Read: Only chairperson
      allow read: if isAuthenticated() && isChairperson();
      // Write: Any authenticated user (for performance tracking)
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && isChairperson();
    }
    
    // Analytics metrics collection (cached metrics)
    match /analytics_metrics/{metricId} {
      // Read/Write: Only chairperson
      allow read: if isAuthenticated() && isChairperson();
      allow write: if isAuthenticated() && isChairperson();
    }
    
    // Analytics queries collection (query performance logs)
    match /analytics_queries/{queryId} {
      // Read/Write: Only chairperson
      allow read: if isAuthenticated() && isChairperson();
      allow write: if isAuthenticated() && isChairperson();
    }
    
    // Analytics cache collection
    match /analytics_cache/{cacheId} {
      // Read/Write: Only chairperson
      allow read: if isAuthenticated() && isChairperson();
      allow write: if isAuthenticated() && isChairperson();
    }
    
    // Generic analytics collection (if used)
    match /analytics/{analyticsId} {
      // Read/Write: Only chairperson
      allow read: if isAuthenticated() && isChairperson();
      allow write: if isAuthenticated() && isChairperson();
    }
    
    // Tracking collection (if used)
    match /tracking/{trackingId} {
      // Read/Write: Only chairperson
      allow read: if isAuthenticated() && isChairperson();
      allow write: if isAuthenticated() && isChairperson();
    }
    
    // ============================================================================
    // DEFAULT DENY RULE (Security by default)
    // ============================================================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
